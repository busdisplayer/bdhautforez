<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Bd du Ht Forez - Transports en commun</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table, th, td {
      border: 1px solid black;
    }

    th, td {
      padding: 10px;
      text-align: center;
    }

    .imminent {
      color: red;
      font-weight: bold;
    }

    .en-station {
      color: green;
      font-weight: bold;
    }

    .pas-de-service {
      color: gray;
      font-weight: bold;
    }
  </style>
</head>
<body>
   <h1>Prochains Bus - Bd du Ht Forez</h1>

  <table id="busTable">
    <thead>
      <tr>
        <th>Destination</th>
        <th>Ligne</th>
        <th>Prochain bus</th>
        <th>Temps d'attente</th>
      </tr>
    </thead>
    <tbody>
      <!-- Le tableau sera rempli par le script -->
    </tbody>
  </table>
  <script>
    let stateHor = -1; // -1 = erreur ou √©tat inconnu
    let wedBool = false;
    let horairesEncours = [];

    const horairesParStatut = {
      0: ["Pas de service"], // Dimanche
      1: ["06:30", "07:30", "08:30", "12:00", "16:30", "18:00"], // Semaine scolaire
      2: ["07:00", "08:00", "12:30", "17:00"], // Mercredi
      3: ["08:00", "10:00", "12:00", "14:00"], // Samedi
      4: ["Pas de service"], // Jour f√©ri√©
      5: ["08:30", "10:30", "14:00", "17:00"], // Vacances scolaires
      6: ["09:00", "11:00", "15:00", "18:00"], // Vacances d'√©t√©
    };

    function getApiUrl() {
      const currentYear = new Date().getFullYear();
      return `https://data.education.gouv.fr/api/explore/v2.1/catalog/datasets/fr-en-calendrier-scolaire/records?limit=20&refine=start_date%3A%22${currentYear}%22&refine=zones%3A%22Zone%20A%22&refine=location%3A%22Lyon%22&refine=population%3A%22-%22`;
    }

    function getStatusDescription(code) {
      switch (code) {
        case 0: return "Dimanche";
        case 1: return "Semaine scolaire (Lundi, Mardi, Jeudi, Vendredi)";
        case 2: return "Mercredi";
        case 3: return "Samedi";
        case 4: return "Jour f√©ri√©";
        case 5: return "Semaine de vacances scolaires";
        case 6: return "Vacances d'√©t√©";
        default: return "√âtat inconnu";
      }
    }

    function getHorairesDuJour(code) {
      return horairesParStatut[code] || ["Erreur : Statut inconnu"];
    }

    async function getVacationStatus() {
      const url = getApiUrl();
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (!data.results) throw new Error("Donn√©es non disponibles");

        const today = new Date();
        const dayOfWeek = today.getDay(); // 0 = Dimanche, 6 = Samedi
        let status = 1; // Par d√©faut : semaine scolaire

        if (dayOfWeek === 3) {
          status = 2; // Mercredi
          wedBool = true;
        } else if (dayOfWeek === 0) {
          status = 0; // Dimanche
        } else if (dayOfWeek === 6) {
          status = 3; // Samedi
        }

        const publicHolidays = ["2025-01-01", "2025-05-01", "2025-07-14", "2025-12-25"];
        const todayStr = today.toISOString().split("T")[0];
        if (publicHolidays.includes(todayStr)) {
          status = 4; // Jour f√©ri√©
        }

        for (const vacation of data.results) {
          const startDate = new Date(vacation.start_date);
          const endDate = new Date(vacation.end_date);
          if (today >= startDate && today <= endDate) {
            status = vacation.description.includes("√ât√©") ? 6 : 5;
            break;
          }
        }

        stateHor = status;
        horairesEncours = getHorairesDuJour(stateHor);

        // Logs d√©taill√©s
        console.log("‚úÖ Statut d√©tect√© :", stateHor);
        console.log("üìÖ Explication :", getStatusDescription(stateHor));
        console.log("üïí Horaires du jour :", horairesEncours);
        if (wedBool) console.log("üîî Aujourd'hui est un mercredi.");

      } catch (error) {
        console.error("‚ùå Erreur lors de la r√©cup√©ration des donn√©es :", error);
      }
    }

    // Lancer tout √ßa
    getVacationStatus();
  </script>
  <script>
    // Exemple de donn√©es suppl√©mentaires (ligne et destination)
    const busData = [
      { ligne: "Ligne 1", destination: "Place Bellecour", horaires: ["06:30", "07:30", "08:30", "12:00", "16:30", "18:00"] },
      { ligne: "Ligne 2", destination: "Gare Part-Dieu", horaires: ["06:45", "08:00", "10:30", "15:00", "17:30"] },
      { ligne: "Ligne 3", destination: "Vieux Lyon", horaires: ["07:00", "08:45", "12:15", "16:45", "18:30"] },
    ];

    // Fonction pour calculer le temps d'attente (en minutes)
    function getTempsAttente(horaire) {
      const now = new Date();
      const nextBusTime = new Date(now.toDateString() + ' ' + horaire);
      const diffInMillis = nextBusTime - now;
      
      if (diffInMillis < 0) return -1; // Pas de service (horaire d√©j√† pass√©)
      return Math.ceil(diffInMillis / 60000); // Temps d'attente en minutes
    }

    // Fonction pour afficher les horaires dans le tableau
    function afficherProchainBus() {
      const tableBody = document.getElementById("busTable").getElementsByTagName("tbody")[0];
      tableBody.innerHTML = ""; // R√©initialiser le tableau avant de l'afficher

      busData.forEach(bus => {
        const prochainesHeures = bus.horaires;
        const now = new Date();
        let tempsAttente = -1;
        let nextBusTime = "";
        let status = "Pas de service";

        // Chercher le prochain bus
        for (let i = 0; i < prochainesHeures.length; i++) {
          const temps = prochainesHeures[i];
          const tempAttente = getTempsAttente(temps);

          if (tempAttente >= 0) {
            tempsAttente = tempAttente;
            nextBusTime = temps;
            break;
          }
        }

        // Mise √† jour du statut et du temps d'attente
        if (tempsAttente === -1) {
          status = "Pas de service";
        } else if (tempsAttente === 0) {
          status = "En station";
        } else if (tempsAttente < 2) {
          status = "Imminent";
        } else {
          status = `${tempsAttente} min`;
        }

        // Ajouter une ligne au tableau
        const row = tableBody.insertRow();
        const cellDestination = row.insertCell(0);
        const cellLigne = row.insertCell(1);
        const cellProchainBus = row.insertCell(2);
        const cellTempsAttente = row.insertCell(3);

        cellDestination.textContent = bus.destination;
        cellLigne.textContent = bus.ligne;
        cellProchainBus.textContent = nextBusTime;
        cellTempsAttente.textContent = status;

        // Ajout de classes pour styliser en fonction du statut
        if (status === "Pas de service") {
          cellTempsAttente.classList.add("pas-de-service");
        } else if (status === "Imminent") {
          cellTempsAttente.classList.add("imminent");
        } else if (status === "En station") {
          cellTempsAttente.classList.add("en-station");
        }
      });
    }

    // Lancer l'affichage du prochain bus au chargement de la page
    afficherProchainBus();

    // Optionnel : rafra√Æchir chaque minute
    setInterval(afficherProchainBus, 60000);
  </script>
</body>
</html>
